---
import Layout from "../layouts/Layout.astro";
import Card from "../components/Card.astro";
import LayoutGrid from "../components/LayoutGrid.astro";
---
<Layout title="Transfer">
  <!-- <LayoutGrid> -->
    <Card slot="left" class="transfer-card">
      <h2>æ–‡æœ¬ä¼ è¾“</h2>
      <p class="description">ä½¿ç”¨ Netlify Blob å®‰å…¨åœ°ä¿å­˜å’Œåˆ†äº«æ–‡æœ¬å†…å®¹</p>
      
      <div class="input-group">
        <label for="text-input">è¾“å…¥å†…å®¹ï¼š</label>
        <textarea id="text-input" rows="12" placeholder="åœ¨è¿™é‡Œè¾“å…¥ä½ æƒ³ä¿å­˜çš„æ–‡æœ¬..."></textarea>
      </div>
      
      <button id="save-button" class="save-button">
        <span class="button-text">ä¿å­˜åˆ°äº‘ç«¯</span>
      </button>
      
      <div id="result" class="result-area"></div>
    </Card>

    <Card slot="right" class="info-card">
      <h3>ä½¿ç”¨è¯´æ˜</h3>
      <ul>
        <li>âœï¸ åœ¨å·¦ä¾§è¾“å…¥æ¡†ä¸­è¾“å…¥ä½ æƒ³ä¿å­˜çš„æ–‡æœ¬</li>
        <li>ğŸ’¾ ç‚¹å‡»"ä¿å­˜åˆ°äº‘ç«¯"æŒ‰é’®</li>
        <li>ğŸ”— è·å–å”¯ä¸€çš„è®¿é—®é“¾æ¥</li>
        <li>ğŸ“¤ åˆ†äº«é“¾æ¥ç»™å…¶ä»–äººæŸ¥çœ‹</li>
      </ul>
      
      <h3>ç‰¹æ€§</h3>
      <ul>
        <li>ğŸ”’ å®‰å…¨å­˜å‚¨åœ¨ Netlify Blob</li>
        <li>âš¡ å¿«é€Ÿè®¿é—®</li>
        <li>ğŸŒ å…¨çƒ CDN åŠ é€Ÿ</li>
        <li>ğŸ“± æ”¯æŒæ‰€æœ‰è®¾å¤‡</li>
      </ul>
    </Card>
  <!-- </LayoutGrid> -->

  <style>
    .transfer-card, .info-card {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .description {
      color: var(--text-secondary);
      margin-top: 0;
    }

    .input-group {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    label {
      font-weight: 600;
      color: var(--text-color);
    }

    textarea {
      width: 100%;
      padding: 0.75rem;
      background-color: var(--bg-secondary);
      color: var(--text-color);
      border: 1px solid var(--border-color);
      border-radius: 0.5rem;
      font-family: 'Geist Mono', monospace;
      font-size: 0.9rem;
      resize: vertical;
      transition: border-color 0.2s ease;
    }

    textarea:focus {
      outline: none;
      border-color: var(--primary);
    }

    textarea::placeholder {
      color: var(--text-secondary);
    }

    .save-button {
      padding: 0.75rem 1.5rem;
      background-color: var(--primary);
      color: white;
      border: none;
      border-radius: 0.5rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 1rem;
    }

    .save-button:hover {
      background-color: var(--primary-light);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(var(--primary-rgb), 0.3);
    }

    .save-button:active {
      transform: translateY(0);
    }

    .save-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .result-area {
      padding: 1rem;
      background-color: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 0.5rem;
      min-height: 3rem;
      color: var(--text-color);
    }

    .result-area:empty {
      display: none;
    }

    .result-area a {
      color: var(--primary-light);
      text-decoration: underline;
    }

    .result-area a:hover {
      color: var(--primary-lightest);
    }

    .info-card h3 {
      margin-top: 1.5rem;
      margin-bottom: 0.5rem;
      color: var(--text-color);
    }

    .info-card h3:first-of-type {
      margin-top: 0;
    }

    .info-card ul {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .info-card li {
      color: var(--text-secondary);
      padding-left: 0.5rem;
    }

    @media screen and (max-width: 768px) {
      textarea {
        font-size: 0.85rem;
      }
    }
  </style>

  <script>
    const saveButton = document.getElementById('save-button') as HTMLButtonElement | null;
    const textInput = document.getElementById('text-input') as HTMLTextAreaElement | null;
    const resultDiv = document.getElementById('result') as HTMLDivElement | null;

    if (!saveButton || !textInput || !resultDiv) {
      console.error('Required elements not found');
      throw new Error('é¡µé¢å…ƒç´ æœªæ­£ç¡®åŠ è½½');
    }

    saveButton.addEventListener('click', async () => {
      const text = textInput.value.trim();
      if (!text) {
        resultDiv.innerHTML = 'âš ï¸ å†…å®¹ä¸èƒ½ä¸ºç©ºï¼';
        resultDiv.style.display = 'block';
        return;
      }

      // ç¦ç”¨æŒ‰é’®ï¼Œæ˜¾ç¤ºåŠ è½½çŠ¶æ€
      saveButton.disabled = true;
      const originalText = saveButton.querySelector('.button-text')!.textContent;
      saveButton.querySelector('.button-text')!.textContent = 'ä¿å­˜ä¸­...';
      resultDiv.innerHTML = 'ğŸ“¤ æ­£åœ¨ä¸Šä¼ åˆ°äº‘ç«¯...';
      resultDiv.style.display = 'block';

      try {
        // å°†æ–‡æœ¬å‘é€åˆ°æˆ‘ä»¬çš„Netlify Function
        const response = await fetch('/.netlify/functions/save-data', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text }),
        });

        const result = await response.json();

        if (response.ok) {
          // æ„å»ºä¸€ä¸ªè®¿é—®é“¾æ¥
          const accessUrl = `/.netlify/functions/get-data?key=${result.key}`;
          const viewUrl = `${window.location.origin}/view?key=${result.key}`;
          
          resultDiv.innerHTML = `
            <div style="color: var(--primary); font-weight: 600; margin-bottom: 0.5rem;">
              âœ… ä¿å­˜æˆåŠŸï¼
            </div>
            <div style="margin-bottom: 0.5rem;">
              <strong>è®¿é—®é”®ï¼š</strong> <code style="background: var(--bg-color); padding: 0.25rem 0.5rem; border-radius: 0.25rem;">${result.key}</code>
            </div>
            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
              <a href="${accessUrl}" target="_blank" style="padding: 0.5rem 1rem; background: var(--primary); color: white; border-radius: 0.25rem; text-decoration: none;">ğŸ“„ æŸ¥çœ‹ JSON</a>
              <button onclick="navigator.clipboard.writeText('${viewUrl}')" style="padding: 0.5rem 1rem; background: var(--bg-color); color: var(--text-color); border: 1px solid var(--border-color); border-radius: 0.25rem; cursor: pointer;">ğŸ“‹ å¤åˆ¶é“¾æ¥</button>
            </div>
          `;
        } else {
          resultDiv.innerHTML = `âŒ ä¿å­˜å¤±è´¥: ${result.error || 'æœªçŸ¥é”™è¯¯'}`;
        }
      } catch (error) {
        resultDiv.innerHTML = `âŒ ä¿å­˜å¤±è´¥: ${error instanceof Error ? error.message : 'ç½‘ç»œé”™è¯¯'}`;
      } finally {
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        saveButton.disabled = false;
        saveButton.querySelector('.button-text')!.textContent = originalText!;
      }
    });
  </script>
</Layout>